<!-- Version: V0.10.33 -->
<section class="dev-section pt-5 mt-5">
    <div class="container border-start border-end border-secondary px-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="dev-section-title m-0">CMS Dashboard</h2>
                <p class="text-muted m-0">Gerenciamento de Conteúdo e Usuários</p>
            </div>
            <div>
                <span class="badge bg-success me-2">Admin Mode</span>
                <button class="btn btn-outline-danger btn-sm" onclick="window.authService.logout()">Sair</button>
            </div>
        </div>

        <!-- Protected Content Check -->
        <div id="admin-content" style="display: none;">
            <div class="row g-4">
                <!-- Sidebar / Stats -->
                <div class="col-md-3">
                    <div class="card bg-dark border-secondary mb-3">
                        <div class="card-body">
                            <h6 class="text-muted">Usuários Totais</h6>
                            <h2 class="fw-bold" id="total-users">-</h2>
                        </div>
                    </div>

                    <div class="list-group bg-dark">
                        <button class="list-group-item list-group-item-action active bg-primary border-primary"
                            onclick="loadTab('users')">Gestão de Usuários</button>
                        <button class="list-group-item list-group-item-action bg-dark text-white border-secondary"
                            onclick="loadTab('blogs')">Blog & Postagens</button>
                        <button class="list-group-item list-group-item-action bg-dark text-white border-secondary"
                            onclick="loadTab('content')">Conteúdo do Site</button>
                        <button class="list-group-item list-group-item-action bg-dark text-white border-secondary"
                            onclick="loadTab('logs')">Logs do Sistema</button>
                    </div>
                </div>

                <!-- Main Area -->
                <div class="col-md-9">
                    <div class="card bg-dark border-secondary">
                        <div class="card-body" id="tab-content">
                            <!-- Content injected via JS -->
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Access Denied -->
        <div id="access-denied" class="text-center py-5" style="display: none;">
            <i class="bi bi-shield-lock-fill fs-1 text-danger mb-3"></i>
            <h3>Acesso Negado</h3>
            <p class="text-muted">Esta área é exclusiva para administradores.</p>
            <a href="/" class="btn btn-secondary mt-3">Voltar para Home</a>
        </div>

    </div>
</section>

<!-- User Modal -->
<div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Editar Usuário</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="user-form">
                    <div class="mb-3">
                        <label class="form-label">Nome</label>
                        <input type="text" class="form-control bg-black border-secondary text-white" name="name"
                            required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control bg-black border-secondary text-white" name="email"
                            required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Roles (separados por vírgula)</label>
                        <input type="text" class="form-control bg-black border-secondary text-white" name="roles"
                            placeholder="user, admin, premium">
                        <small class="text-muted">Opções: user, admin, premium</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select bg-black border-secondary text-white" name="status">
                            <option value="active">Ativo</option>
                            <option value="inactive">Inativo</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Blog Modal -->
<div class="modal fade" id="blogModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Editar Postagem</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="blog-form">
                    <input type="hidden" name="id">
                    <div class="mb-3">
                        <label class="form-label">Título</label>
                        <input type="text" class="form-control bg-black border-secondary text-white" name="title"
                            required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Slug (URL)</label>
                        <input type="text" class="form-control bg-black border-secondary text-white" name="slug"
                            required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Conteúdo (Markdown suportado)</label>
                        <textarea class="form-control bg-black border-secondary text-white" name="content" rows="10"
                            required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Autor</label>
                            <input type="text" class="form-control bg-black border-secondary text-white" name="author"
                                required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Categoria</label>
                            <input type="text" class="form-control bg-black border-secondary text-white"
                                name="category">
                        </div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="publishedCheck" name="published">
                        <label class="form-check-label" for="publishedCheck">Publicado</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveBlog()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        // Auth Check
        const auth = window.authService;
        const content = document.getElementById('admin-content');
        const denied = document.getElementById('access-denied');
        let currentBlogId = null;

        // Simple Router for Tabs
        window.loadTab = async function (tab) {
            // Update Active State
            const btns = document.querySelectorAll('.list-group-item');
            btns.forEach(el => el.classList.remove('active', 'bg-primary', 'border-primary'));
            btns.forEach(el => el.classList.add('bg-dark', 'text-white', 'border-secondary'));

            // Find button by text content roughly
            const map = { 'users': 'Usuários', 'blogs': 'Blog', 'content': 'Conteúdo', 'logs': 'Logs' };
            const activeBtn = Array.from(btns).find(el => el.textContent.includes(map[tab]));
            if (activeBtn) {
                activeBtn.classList.add('active', 'bg-primary', 'border-primary');
                activeBtn.classList.remove('bg-dark', 'text-white', 'border-secondary');
            }

            const container = document.getElementById('tab-content');
            container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';

            if (tab === 'users') {
                renderUsers(container);
            } else if (tab === 'blogs') {
                renderBlogs(container);
            } else if (tab === 'content') {
                renderContentManager(container);
            } else {
                renderLogs(container);
            }
        }

        async function renderUsers(container) {
            let usersList = [];
            try {
                const response = await window.core.fetchAPI('/auth/users');
                if (response && response.success && Array.isArray(response.data)) {
                    usersList = response.data;
                }
            } catch (err) {
                console.warn('Using mock users');
                usersList = [
                    { id: 1, name: 'Admin', email: 'admin@msoft.com.br', roles: ['admin'], status: 'active' },
                ];
            }

            document.getElementById('total-users').textContent = usersList.length;

            let html = `
                <h4 class="mb-4">Gestão de Usuários</h4>
                <div class="table-responsive">
                <table class="table table-dark table-hover">
                    <thead><tr><th>Nome</th><th>Email</th><th>Roles</th><th>Status</th><th>Ações</th></tr></thead>
                    <tbody>
             `;
            usersList.forEach(u => {
                // Ensure roles is an array
                const roles = Array.isArray(u.roles) ? u.roles : (u.role ? [u.role] : ['user']);

                const rolesBadges = roles.map(r => {
                    let color = 'secondary';
                    if (r === 'admin') color = 'danger';
                    if (r === 'premium') color = 'warning';
                    return `<span class="badge bg-${color} me-1">${r}</span>`
                }).join('');

                html += `<tr>
                    <td>${u.name}</td>
                    <td>${u.email}</td>
                    <td>${rolesBadges}</td>
                    <td>${u.status}</td>
                    <td><button class="btn btn-sm btn-outline-light" onclick='editUser(${JSON.stringify(u).replace(/'/g, "&#39;")})'><i class="bi bi-pencil"></i></button></td>
                 </tr>`;
            });
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        async function renderBlogs(container) {
            let blogs = [];
            try {
                const res = await window.core.fetchAPI('/blogs/all'); // Admin route
                if (res && res.success) blogs = res.data;
            } catch (e) {
                // Fallback empty
            }

            let html = `
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="m-0">Postagens do Blog</h4>
                    <button class="btn btn-primary btn-sm" onclick="openBlogModal()">
                        <i class="bi bi-plus-lg"></i> Novo Post
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>Título</th>
                                <th>Autor</th>
                                <th>Status</th>
                                <th>Data</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            if (blogs.length === 0) {
                html += `<tr><td colspan="5" class="text-center text-muted">Nenhuma postagem encontrada.</td></tr>`;
            } else {
                blogs.forEach(b => {
                    html += `
                        <tr>
                            <td>${b.title}</td>
                            <td>${b.author}</td>
                            <td><span class="badge bg-${b.published ? 'success' : 'warning'}">${b.published ? 'Publicado' : 'Rascunho'}</span></td>
                            <td>${new Date(b.createdAt).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" onclick='editBlog(${JSON.stringify(b).replace(/'/g, "&#39;")})'><i class="bi bi-pencil"></i></button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteBlog('${b._id}')"><i class="bi bi-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
            }
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function renderContentManager(container) {
            const cms = window.ContentService;
            const sections = ['hero', 'features', 'about', 'testimonials', 'cta'];

            let html = `
                <h4 class="mb-4">Gerenciador de Seções (Homepage)</h4>
                <div class="alert alert-info"><i class="bi bi-info-circle"></i> Use os interruptores para exibir ou ocultar seções na página inicial.</div>
                <div class="list-group bg-dark mb-4">
            `;

            sections.forEach(sec => {
                const data = cms.getSection(sec) || {};
                const isEnabled = data.enabled !== false;

                html += `
                    <div class="list-group-item bg-black border-secondary d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1 text-white text-capitalize">${sec} Section</h5>
                            <small class="text-muted">Status: ${isEnabled ? 'Visível' : 'Oculto'}</small>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" 
                                onchange="toggleSection('${sec}', this.checked)" ${isEnabled ? 'checked' : ''}>
                        </div>
                    </div>
                `;
            });

            html += `
                </div>
                <div class="d-grid gap-2">
                    <a href="/cms" class="btn btn-outline-primary"><i class="bi bi-pencil-square"></i> Editar Textos e Imagens (CMS Completo)</a>
                </div>
            `;

            container.innerHTML = html;
        }

        async function renderLogs(container) {
            let logs = [];
            try {
                const res = await window.core.fetchAPI('/logs');
                if (res && res.success) logs = res.data;
            } catch (e) { console.warn('Logs error', e); }

            if (logs.length === 0) {
                // Fallback if no logs
                logs.push({ action: 'INFO', details: 'No system logs found.', level: 'info', createdAt: new Date() });
            }

            let html = `
                <h4 class="mb-4">Logs do Sistema</h4>
                <div class="bg-black p-3 rounded font-monospace small" style="height: 400px; overflow-y: auto;">
             `;

            logs.forEach(log => {
                let color = 'text-success';
                if (log.level === 'warning') color = 'text-warning';
                if (log.level === 'error') color = 'text-danger';

                const date = new Date(log.createdAt).toLocaleString();
                html += `<div class="${color}">[${date}] [${log.action}] ${log.details} ${log.user ? `(User: ${log.user})` : ''}</div>`;
            });

            html += `</div>`;
            container.innerHTML = html;
        }

        // User Actions
        window.editUser = function (user) {
            window.currentUserToEdit = user._id; // Store ID
            const form = document.getElementById('user-form');
            form.name.value = user.name || '';
            form.email.value = user.email || '';

            // Handle Roles (Array to comma string)
            let roles = user.roles || [];
            if (!Array.isArray(roles) && user.role) roles = [user.role];
            form.roles.value = roles.join(', ');

            form.status.value = user.status || 'active';

            new bootstrap.Modal(document.getElementById('userModal')).show();
        };

        window.saveUser = async function () {
            const form = document.getElementById('user-form');
            const id = window.currentUserToEdit;
            if (!id) return;

            const data = {
                name: form.name.value,
                email: form.email.value,
                roles: form.roles.value, // Backend will split string
                status: form.status.value
            };

            try {
                const res = await window.core.fetchAPI(`/auth/users/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                if (res && res.success) {
                    bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
                    loadTab('users');
                } else {
                    alert('Erro ao salvar usuário: ' + (res?.error || 'Erro desconhecido'));
                }
            } catch (e) {
                console.error(e);
                alert('Erro de conexão ao salvar usuário');
            }
        };

        // ... existing blog actions ...

        // Blog Actions
        window.openBlogModal = function () {
            document.getElementById('blog-form').reset();
            currentBlogId = null;
            new bootstrap.Modal(document.getElementById('blogModal')).show();
        };

        window.editBlog = function (blog) {
            currentBlogId = blog._id;
            const form = document.getElementById('blog-form');
            form.title.value = blog.title;
            form.slug.value = blog.slug;
            form.content.value = blog.content;
            form.author.value = blog.author;
            form.category.value = blog.category || '';
            form.published.checked = blog.published;
            new bootstrap.Modal(document.getElementById('blogModal')).show();
        };

        window.saveBlog = async function () {
            const form = document.getElementById('blog-form');
            const data = {
                title: form.title.value,
                slug: form.slug.value,
                content: form.content.value,
                author: form.author.value,
                category: form.category.value,
                published: form.published.checked
            };

            try {
                let res;
                if (currentBlogId) {
                    res = await window.core.fetchAPI(`/blogs/${currentBlogId}`, { method: 'PUT', body: JSON.stringify(data) });
                } else {
                    res = await window.core.fetchAPI('/blogs', { method: 'POST', body: JSON.stringify(data) });
                }

                if (res && res.success) {
                    bootstrap.Modal.getInstance(document.getElementById('blogModal')).hide();
                    loadTab('blogs');
                    // Toast success
                } else {
                    alert('Erro ao salvar: ' + (res?.error || 'Unknown error'));
                }
            } catch (e) {
                console.error(e);
                alert('Erro de conexão');
            }
        };

        window.deleteBlog = async function (id) {
            if (!confirm('Tem certeza?')) return;
            try {
                await window.core.fetchAPI(`/blogs/${id}`, { method: 'DELETE' });
                loadTab('blogs');
            } catch (e) { console.error(e); }
        };

        // Section Actions
        window.toggleSection = function (section, enabled) {
            const cms = window.ContentService;
            const current = cms.getSection(section) || {};
            current.enabled = enabled;
            cms.updateSection(section, current);
            // Optional: Toast feedback
        };

        if (auth && auth.isAuthenticated() && auth.hasRole('admin')) {
            content.style.display = 'block';
            loadTab('users');
        } else {
            denied.style.display = 'block';
        }
    })();
</script>