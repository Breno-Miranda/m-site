<div class="container py-5 mt-5 pt-5" id="cms-root">
  <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-4">
    <div>
      <h1 class="h2 mb-1">Content Manager</h1>
      <p class="text-muted mb-1">Atualize o conteúdo do site em tempo real. Os dados ficam salvos no seu navegador.</p>
      <small id="updated-label" class="text-muted"></small>
    </div>
    <div class="btn-group">
      <button class="btn btn-outline-primary" id="export-json" type="button">
        <i class="bi bi-download me-2"></i>Exportar JSON
      </button>
      <label class="btn btn-outline-secondary mb-0">
        <i class="bi bi-upload me-2"></i>Importar JSON
        <input type="file" id="import-json" class="visually-hidden" accept="application/json">
      </label>
      <button class="btn btn-outline-danger" id="reset-content" type="button">
        <i class="bi bi-arrow-counterclockwise me-2"></i>Restaurar padrão
      </button>
    </div>
  </div>

  <div class="alert alert-info d-flex align-items-center gap-2" role="alert">
    <i class="bi bi-info-circle-fill"></i>
    <span>As alterações ficam disponíveis imediatamente no site. Compartilhe o JSON exportado para replicar o conteúdo
      em outros dispositivos.</span>
  </div>

  <div class="accordion mt-4" id="cms-accordion">
    <!-- Hero Section -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingHero">
        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#cms-hero"
          aria-expanded="true" aria-controls="cms-hero">
          Hero / Seção de abertura
        </button>
      </h2>
      <div id="cms-hero" class="accordion-collapse collapse show" aria-labelledby="headingHero"
        data-bs-parent="#cms-accordion">
        <div class="accordion-body">
          <form id="hero-form" class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Eyebrow</label>
              <input type="text" class="form-control" name="eyebrow" placeholder="Ex: Framework Frontend">
            </div>
            <div class="col-md-4">
              <label class="form-label">Título</label>
              <input type="text" class="form-control" name="title" placeholder="Título principal" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Subtítulo</label>
              <input type="text" class="form-control" name="subtitle" placeholder="Subtítulo">
            </div>
            <div class="col-12">
              <label class="form-label">Descrição</label>
              <textarea class="form-control" name="description" rows="3"></textarea>
            </div>
            <div class="col-md-6">
              <div class="border rounded p-3 h-100">
                <h6 class="fw-bold mb-3">Ação principal</h6>
                <div class="mb-3">
                  <label class="form-label">Texto</label>
                  <input type="text" class="form-control" name="primaryAction.label">
                </div>
                <div class="mb-3">
                  <label class="form-label">Link</label>
                  <input type="text" class="form-control" name="primaryAction.href" placeholder="/contact">
                </div>
                <div>
                  <label class="form-label">Ícone (classe Bootstrap)</label>
                  <input type="text" class="form-control" name="primaryAction.icon" placeholder="bi-envelope-heart">
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="border rounded p-3 h-100">
                <h6 class="fw-bold mb-3">Ação secundária</h6>
                <div class="mb-3">
                  <label class="form-label">Texto</label>
                  <input type="text" class="form-control" name="secondaryAction.label">
                </div>
                <div class="mb-3">
                  <label class="form-label">Link</label>
                  <input type="text" class="form-control" name="secondaryAction.href" placeholder="/materials">
                </div>
                <div>
                  <label class="form-label">Ícone (classe Bootstrap)</label>
                  <input type="text" class="form-control" name="secondaryAction.icon" placeholder="bi-journal-text">
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Ícone do badge</label>
              <input type="text" class="form-control" name="badgeIcon" placeholder="bi-stars">
            </div>
            <div class="col-12 text-end">
              <button class="btn btn-primary" type="submit">
                <i class="bi bi-save me-2"></i>Salvar hero
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Features Section -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingFeatures">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
          data-bs-target="#cms-features" aria-expanded="false" aria-controls="cms-features">
          Cards de destaque
        </button>
      </h2>
      <div id="cms-features" class="accordion-collapse collapse" aria-labelledby="headingFeatures"
        data-bs-parent="#cms-accordion">
        <div class="accordion-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h6 class="mb-0">Até quatro destaques</h6>
              <small class="text-muted">Defina ícone, cor e CTA de cada card.</small>
            </div>
            <div class="btn-group">
              <button class="btn btn-outline-primary btn-sm" id="add-feature" type="button">
                <i class="bi bi-plus-circle me-1"></i>Novo card
              </button>
              <button class="btn btn-primary btn-sm" id="save-features" type="button">
                <i class="bi bi-save me-1"></i>Salvar cards
              </button>
            </div>
          </div>
          <div class="row g-3" id="features-list"></div>
        </div>
      </div>
    </div>

    <!-- About Section -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingAbout">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cms-about"
          aria-expanded="false" aria-controls="cms-about">
          Seção "Sobre"
        </button>
      </h2>
      <div id="cms-about" class="accordion-collapse collapse" aria-labelledby="headingAbout"
        data-bs-parent="#cms-accordion">
        <div class="accordion-body">
          <form id="about-form" class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Título</label>
              <input type="text" class="form-control" name="title">
            </div>
            <div class="col-md-6">
              <label class="form-label">Título da coluna 2</label>
              <input type="text" class="form-control" name="supportTitle">
            </div>
            <div class="col-md-6">
              <label class="form-label">Descrição principal</label>
              <textarea class="form-control" name="description" rows="4"></textarea>
            </div>
            <div class="col-md-6">
              <label class="form-label">Descrição complementar</label>
              <textarea class="form-control" name="supportDescription" rows="4"></textarea>
            </div>
            <div class="col-md-4">
              <label class="form-label">Lista de benefícios (1 item por linha)</label>
              <textarea class="form-control" name="bullets" rows="6"></textarea>
            </div>
            <div class="col-md-4">
              <label class="form-label">Coluna complementar 1</label>
              <textarea class="form-control" name="supportColumn1" rows="6" placeholder="Um item por linha"></textarea>
            </div>
            <div class="col-md-4">
              <label class="form-label">Coluna complementar 2</label>
              <textarea class="form-control" name="supportColumn2" rows="6" placeholder="Um item por linha"></textarea>
            </div>
            <div class="col-12 text-end">
              <button class="btn btn-primary" type="submit">
                <i class="bi bi-save me-2"></i>Salvar seção
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Testimonials -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingTestimonials">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
          data-bs-target="#cms-testimonials" aria-expanded="false" aria-controls="cms-testimonials">
          Depoimentos
        </button>
      </h2>
      <div id="cms-testimonials" class="accordion-collapse collapse" aria-labelledby="headingTestimonials"
        data-bs-parent="#cms-accordion">
        <div class="accordion-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h6 class="mb-0">Prova social</h6>
              <small class="text-muted">Adicione histórias reais para gerar confiança.</small>
            </div>
            <div class="btn-group">
              <button class="btn btn-outline-primary btn-sm" id="add-testimonial" type="button">
                <i class="bi bi-plus-circle me-1"></i>Novo depoimento
              </button>
              <button class="btn btn-primary btn-sm" id="save-testimonials" type="button">
                <i class="bi bi-save me-1"></i>Salvar depoimentos
              </button>
            </div>
          </div>
          <div class="row g-3" id="testimonials-list"></div>
        </div>
      </div>
    </div>

    <!-- CTA Section -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingCTA">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cms-cta"
          aria-expanded="false" aria-controls="cms-cta">
          Chamada final (CTA)
        </button>
      </h2>
      <div id="cms-cta" class="accordion-collapse collapse" aria-labelledby="headingCTA"
        data-bs-parent="#cms-accordion">
        <div class="accordion-body">
          <form id="cta-form" class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Título</label>
              <input type="text" class="form-control" name="title">
            </div>
            <div class="col-md-6">
              <label class="form-label">Descrição</label>
              <textarea class="form-control" name="description" rows="3"></textarea>
            </div>
            <div class="col-md-4">
              <label class="form-label">Texto do botão</label>
              <input type="text" class="form-control" name="action.label">
            </div>
            <div class="col-md-4">
              <label class="form-label">Link do botão</label>
              <input type="text" class="form-control" name="action.href">
            </div>
            <div class="col-md-4">
              <label class="form-label">Ícone</label>
              <input type="text" class="form-control" name="action.icon" placeholder="bi-calendar-check">
            </div>
            <div class="col-12 text-end">
              <button class="btn btn-primary" type="submit">
                <i class="bi bi-save me-2"></i>Salvar CTA
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    const cms = window.ContentService;
    const root = document.getElementById('cms-root');
    if (!cms || !root) {
      if (root) {
        root.innerHTML = '<div class="alert alert-danger">ContentService indisponível. Verifique se os scripts foram carregados.</div>';
      }
      return;
    }

    let content = cms.getAll();

    const notify = (message, type = 'success') => {
      if (window.core?.toast) {
        window.core.toast(message, type);
      } else {
        console[type === 'error' ? 'error' : 'log'](message);
      }
    };

    const updatedLabel = document.getElementById('updated-label');
    const updateTimestampLabel = () => {
      if (!updatedLabel) return;
      const timestamp = content?.seo?.updatedAt;
      updatedLabel.textContent = timestamp
        ? `Última atualização: ${new Date(timestamp).toLocaleString('pt-BR')}`
        : 'Nenhuma edição registrada ainda.';
    };

    const bumpTimestamp = () => {
      const seo = cms.getSection('seo') || {};
      seo.updatedAt = new Date().toISOString();
      cms.updateSection('seo', seo);
    };

    const getDeep = (obj = {}, path = '') => {
      if (!path) return obj;
      return path.split('.').reduce((acc, key) => (acc && acc[key] !== undefined ? acc[key] : ''), obj);
    };

    const setDeep = (obj = {}, path = '', value) => {
      if (!path) return;
      const keys = path.split('.');
      keys.reduce((acc, key, index) => {
        if (index === keys.length - 1) {
          acc[key] = value;
          return acc;
        }
        if (!acc[key] || typeof acc[key] !== 'object') {
          acc[key] = {};
        }
        return acc[key];
      }, obj);
    };

    const heroForm = document.getElementById('hero-form');
    const aboutForm = document.getElementById('about-form');
    const ctaForm = document.getElementById('cta-form');
    const featuresList = document.getElementById('features-list');
    const testimonialsList = document.getElementById('testimonials-list');

    const fillHeroForm = () => {
      if (!heroForm) return;
      heroForm.querySelectorAll('[name]').forEach((input) => {
        input.value = getDeep(content.hero, input.name) || '';
      });
    };

    if (heroForm) {
      heroForm.addEventListener('input', (event) => {
        const { name, value } = event.target;
        if (!name) return;
        content.hero = content.hero || {};
        setDeep(content.hero, name, value);
      });

      heroForm.addEventListener('submit', (event) => {
        event.preventDefault();
        cms.updateSection('hero', content.hero || {});
        bumpTimestamp();
        notify('Hero atualizado com sucesso!');
      });
    }

    const fillAboutForm = () => {
      if (!aboutForm) return;
      aboutForm.elements['title'].value = content.about?.title || '';
      aboutForm.elements['supportTitle'].value = content.about?.supportTitle || '';
      aboutForm.elements['description'].value = content.about?.description || '';
      aboutForm.elements['supportDescription'].value = content.about?.supportDescription || '';
      aboutForm.elements['bullets'].value = (content.about?.bullets || []).join('\n');
      aboutForm.elements['supportColumn1'].value = (content.about?.supportColumns?.[0] || []).join('\n');
      aboutForm.elements['supportColumn2'].value = (content.about?.supportColumns?.[1] || []).join('\n');
    };

    if (aboutForm) {
      aboutForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const formData = new FormData(aboutForm);
        const toLines = (value) =>
          (value || '')
            .split('\n')
            .map((line) => line.trim())
            .filter(Boolean);

        const updated = {
          title: formData.get('title') || '',
          description: formData.get('description') || '',
          bullets: toLines(formData.get('bullets')),
          supportTitle: formData.get('supportTitle') || '',
          supportDescription: formData.get('supportDescription') || '',
          supportColumns: [toLines(formData.get('supportColumn1')), toLines(formData.get('supportColumn2'))],
        };

        content.about = updated;
        cms.updateSection('about', updated);
        bumpTimestamp();
        notify('Seção "Sobre" atualizada com sucesso!');
      });
    }

    const fillCTAForm = () => {
      if (!ctaForm) return;
      ctaForm.querySelectorAll('[name]').forEach((input) => {
        input.value = getDeep(content.cta, input.name) || '';
      });
    };

    if (ctaForm) {
      ctaForm.addEventListener('input', (event) => {
        const { name, value } = event.target;
        if (!name) return;
        content.cta = content.cta || {};
        setDeep(content.cta, name, value);
      });

      ctaForm.addEventListener('submit', (event) => {
        event.preventDefault();
        cms.updateSection('cta', content.cta || {});
        bumpTimestamp();
        notify('CTA atualizado!');
      });
    }

    const featureTemplate = (item = {}, index) => `
    <div class="col-md-6" data-item-index="${index}">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">Card ${index + 1}</h6>
            <button class="btn btn-link text-danger p-0" data-action="remove-feature" data-index="${index}" type="button">
              <i class="bi bi-trash"></i>
            </button>
          </div>
          <div class="mb-3">
            <label class="form-label">Título</label>
            <input type="text" class="form-control" data-field="title" data-index="${index}" value="${item.title || ''}">
          </div>
          <div class="mb-3">
            <label class="form-label">Descrição</label>
            <textarea class="form-control" data-field="description" data-index="${index}" rows="2">${item.description || ''}</textarea>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Link</label>
              <input type="text" class="form-control" data-field="href" data-index="${index}" value="${item.href || ''}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Tema</label>
              <select class="form-select" data-field="theme" data-index="${index}">
                ${['primary', 'success', 'info', 'warning', 'danger']
        .map((option) => `<option value="${option}" ${item.theme === option ? 'selected' : ''}>${option}</option>`)
        .join('')}
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Ícone</label>
              <input type="text" class="form-control" data-field="icon" data-index="${index}" value="${item.icon || ''}">
            </div>
          </div>
          <div class="mt-3">
            <label class="form-label">Texto do botão</label>
            <input type="text" class="form-control" data-field="ctaLabel" data-index="${index}" value="${item.ctaLabel || ''}">
          </div>
        </div>
      </div>
    </div>
  `;

    const testimonialTemplate = (item = {}, index) => `
    <div class="col-md-6" data-testimonial-index="${index}">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">Depoimento ${index + 1}</h6>
            <button class="btn btn-link text-danger p-0" data-action="remove-testimonial" data-index="${index}" type="button">
              <i class="bi bi-trash"></i>
            </button>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Nome</label>
              <input type="text" class="form-control" data-field="name" data-index="${index}" value="${item.name || ''}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Relação</label>
              <input type="text" class="form-control" data-field="relation" data-index="${index}" value="${item.relation || ''}">
            </div>
            <div class="col-12">
              <label class="form-label">Depoimento</label>
              <textarea class="form-control" data-field="quote" data-index="${index}" rows="3">${item.quote || ''}</textarea>
            </div>
            <div class="col-md-6">
              <label class="form-label">Tom (cor)</label>
              <select class="form-select" data-field="tone" data-index="${index}">
                ${['primary', 'success', 'info', 'warning']
        .map((option) => `<option value="${option}" ${item.tone === option ? 'selected' : ''}>${option}</option>`)
        .join('')}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Ícone</label>
              <input type="text" class="form-control" data-field="icon" data-index="${index}" value="${item.icon || ''}">
            </div>
          </div>
        </div>
      </div>
    </div>
  `;

    const renderFeaturesList = () => {
      if (!featuresList) return;
      const items = content.features || [];
      if (!items.length) {
        featuresList.innerHTML = '<div class="col-12 text-muted text-center">Nenhum card cadastrado. Clique em "Novo card" para começar.</div>';
        return;
      }
      featuresList.innerHTML = items.map((item, index) => featureTemplate(item, index)).join('');
    };

    const renderTestimonialsList = () => {
      if (!testimonialsList) return;
      const items = content.testimonials || [];
      if (!items.length) {
        testimonialsList.innerHTML = '<div class="col-12 text-muted text-center">Adicione depoimentos para gerar confiança.</div>';
        return;
      }
      testimonialsList.innerHTML = items.map((item, index) => testimonialTemplate(item, index)).join('');
    };

    document.getElementById('add-feature')?.addEventListener('click', () => {
      content.features = content.features || [];
      content.features.push({
        title: 'Novo destaque',
        description: '',
        href: '/',
        icon: 'bi-star',
        theme: 'primary',
        ctaLabel: 'Saiba mais',
      });
      renderFeaturesList();
    });

    document.getElementById('save-features')?.addEventListener('click', () => {
      cms.updateSection('features', content.features || []);
      bumpTimestamp();
      notify('Cards de destaque salvos!');
    });

    featuresList?.addEventListener('input', (event) => {
      const field = event.target.dataset.field;
      if (field === undefined) return;
      const index = Number(event.target.dataset.index);
      if (!Number.isFinite(index)) return;
      content.features[index][field] = event.target.value;
    });

    featuresList?.addEventListener('click', (event) => {
      const actionBtn = event.target.closest('[data-action="remove-feature"]');
      if (!actionBtn) return;
      const index = Number(actionBtn.dataset.index);
      content.features.splice(index, 1);
      renderFeaturesList();
    });

    document.getElementById('add-testimonial')?.addEventListener('click', () => {
      content.testimonials = content.testimonials || [];
      content.testimonials.push({
        name: 'Nome da família',
        relation: 'Família atendida',
        quote: '',
        tone: 'primary',
        icon: 'bi-person-circle',
      });
      renderTestimonialsList();
    });

    document.getElementById('save-testimonials')?.addEventListener('click', () => {
      cms.updateSection('testimonials', content.testimonials || []);
      bumpTimestamp();
      notify('Depoimentos salvos!');
    });

    testimonialsList?.addEventListener('input', (event) => {
      const field = event.target.dataset.field;
      if (field === undefined) return;
      const index = Number(event.target.dataset.index);
      if (!Number.isFinite(index)) return;
      content.testimonials[index][field] = event.target.value;
    });

    testimonialsList?.addEventListener('click', (event) => {
      const actionBtn = event.target.closest('[data-action="remove-testimonial"]');
      if (!actionBtn) return;
      const index = Number(actionBtn.dataset.index);
      content.testimonials.splice(index, 1);
      renderTestimonialsList();
    });

    document.getElementById('export-json')?.addEventListener('click', () => {
      const data = cms.getAll();
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `cms-content-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    });

    document.getElementById('import-json')?.addEventListener('change', (event) => {
      const file = event.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (loadEvent) => {
        try {
          const parsed = JSON.parse(loadEvent.target.result);
          if (typeof parsed !== 'object' || Array.isArray(parsed)) {
            throw new Error('JSON inválido');
          }
          Object.keys(parsed).forEach((section) => {
            cms.updateSection(section, parsed[section]);
          });
          notify('Conteúdo importado com sucesso!');
        } catch (error) {
          console.error(error);
          notify('Não foi possível importar o arquivo selecionado.', 'error');
        } finally {
          event.target.value = '';
        }
      };
      reader.readAsText(file);
    });

    document.getElementById('reset-content')?.addEventListener('click', () => {
      if (!confirm('Deseja realmente restaurar o conteúdo padrão?')) return;
      const fresh = cms.reset();
      content = fresh;
      updateTimestampLabel();
      hydrateAll(fresh);
      notify('Conteúdo restaurado ao padrão.');
    });

    const hydrateAll = (latestContent) => {
      content = latestContent || cms.getAll();
      fillHeroForm();
      fillAboutForm();
      fillCTAForm();
      renderFeaturesList();
      renderTestimonialsList();
      updateTimestampLabel();
    };

    cms.subscribe('*', (data) => {
      hydrateAll(data);
    });

    hydrateAll(content);
  })();
</script>