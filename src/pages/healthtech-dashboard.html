<div class="container mt-5 fade-in">
    <!-- Header with gradient accent -->
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <span class="dev-hero-badge">
                <i class="bi bi-activity"></i> Sistema Ativo
            </span>
            <h1 class="fw-bold mb-2">
                <span class="gradient-text">HealthTech</span> Dashboard
            </h1>
            <p class="text-secondary mb-0">Farmácia 4.0 - Gestão Inteligente</p>
        </div>
        <div class="d-flex gap-3">
            <a href="/healthtech-patients" class="dev-btn dev-btn-secondary">
                <i class="bi bi-people-fill"></i> Pacientes
            </a>
            <a href="/healthtech-formulas" class="dev-btn dev-btn-primary">
                <i class="bi bi-prescription2"></i> Fórmulas
            </a>
        </div>
    </div>

    <!-- Stats Cards Grid -->
    <div class="row g-4 mb-5">
        <!-- Total Patients -->
        <div class="col-lg-3 col-md-6">
            <div class="dev-skill-card h-100" style="cursor: pointer;" onclick="location.href='/healthtech-patients'">
                <div class="d-flex align-items-center">
                    <div class="dev-skill-icon me-3" style="background: rgba(59, 130, 246, 0.1);">
                        <i class="bi bi-people-fill" style="color: var(--dev-accent-primary);"></i>
                    </div>
                    <div>
                        <p class="text-secondary mb-1 small">Total de Pacientes</p>
                        <h2 class="fw-bold mb-0" id="total-patients">
                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        </h2>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-top border-secondary"
                    style="border-color: var(--dev-border-color) !important;">
                    <small class="text-secondary">
                        <i class="bi bi-arrow-up-right text-success me-1"></i>
                        <span id="new-patients-month">0</span> novos este mês
                    </small>
                </div>
            </div>
        </div>

        <!-- Formulas -->
        <div class="col-lg-3 col-md-6">
            <div class="dev-skill-card h-100" style="cursor: pointer;" onclick="location.href='/healthtech-formulas'">
                <div class="d-flex align-items-center">
                    <div class="dev-skill-icon me-3" style="background: rgba(16, 185, 129, 0.1);">
                        <i class="bi bi-capsule" style="color: var(--dev-accent-success);"></i>
                    </div>
                    <div>
                        <p class="text-secondary mb-1 small">Fórmulas Manipuladas</p>
                        <h2 class="fw-bold mb-0" id="total-formulas">
                            <div class="spinner-border spinner-border-sm text-success" role="status"></div>
                        </h2>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-top" style="border-color: var(--dev-border-color) !important;">
                    <small class="text-secondary">
                        <i class="bi bi-clock-history me-1"></i>
                        <span id="pending-formulas">0</span> em produção
                    </small>
                </div>
            </div>
        </div>

        <!-- Consultations -->
        <div class="col-lg-3 col-md-6">
            <div class="dev-skill-card h-100">
                <div class="d-flex align-items-center">
                    <div class="dev-skill-icon me-3" style="background: rgba(6, 182, 212, 0.1);">
                        <i class="bi bi-clipboard2-pulse" style="color: var(--dev-accent-tertiary);"></i>
                    </div>
                    <div>
                        <p class="text-secondary mb-1 small">Consultas do Mês</p>
                        <h2 class="fw-bold mb-0" id="total-consultations">
                            <div class="spinner-border spinner-border-sm text-info" role="status"></div>
                        </h2>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-top" style="border-color: var(--dev-border-color) !important;">
                    <small class="text-secondary">
                        <i class="bi bi-calendar-check me-1"></i>
                        <span id="today-consultations">0</span> hoje
                    </small>
                </div>
            </div>
        </div>

        <!-- NPS/Satisfaction -->
        <div class="col-lg-3 col-md-6">
            <div class="dev-skill-card h-100">
                <div class="d-flex align-items-center">
                    <div class="dev-skill-icon me-3" style="background: rgba(245, 158, 11, 0.1);">
                        <i class="bi bi-star-fill" style="color: var(--dev-accent-warning);"></i>
                    </div>
                    <div>
                        <p class="text-secondary mb-1 small">NPS Score</p>
                        <h2 class="fw-bold mb-0" id="nps-score">
                            --
                        </h2>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-top" style="border-color: var(--dev-border-color) !important;">
                    <small class="text-secondary">
                        <i class="bi bi-graph-up me-1"></i>
                        Satisfação dos pacientes
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="row g-4">
        <!-- Recent Activities -->
        <div class="col-lg-8">
            <div class="dev-skill-card h-100">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold mb-0">
                        <i class="bi bi-activity me-2 gradient-text"></i>Atividades Recentes
                    </h5>
                    <span class="dev-tech-pill">
                        <i class="bi bi-clock"></i> Últimas 24h
                    </span>
                </div>

                <div id="recent-activities">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions & Tips -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="dev-skill-card mb-4">
                <h5 class="fw-bold mb-4">
                    <i class="bi bi-lightning-charge-fill me-2 gradient-text"></i>Ações Rápidas
                </h5>
                <div class="d-grid gap-2">
                    <a href="/healthtech-patients#new" class="dev-btn dev-btn-secondary justify-content-start">
                        <i class="bi bi-person-plus"></i> Novo Paciente
                    </a>
                    <button class="dev-btn dev-btn-secondary justify-content-start" onclick="openNewConsultation()">
                        <i class="bi bi-clipboard-plus"></i> Nova Consulta
                    </button>
                    <a href="/healthtech-formulas#new" class="dev-btn dev-btn-secondary justify-content-start">
                        <i class="bi bi-plus-circle"></i> Nova Fórmula
                    </a>
                </div>
            </div>

            <!-- Health Tips -->
            <div class="dev-skill-card">
                <h5 class="fw-bold mb-4">
                    <i class="bi bi-lightbulb-fill me-2" style="color: var(--dev-accent-warning);"></i>Dicas de Saúde
                </h5>
                <div id="tips-container">
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Follow-ups Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="dev-skill-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold mb-0">
                        <i class="bi bi-bell-fill me-2" style="color: var(--dev-accent-tertiary);"></i>
                        Follow-ups Pendentes
                    </h5>
                    <span class="badge rounded-pill" style="background: var(--dev-gradient-primary);"
                        id="pending-followups-badge">
                        0
                    </span>
                </div>
                <div id="pending-followups">
                    <div class="text-center py-4 text-secondary">
                        <i class="bi bi-check-circle fs-1 mb-3 d-block" style="opacity: 0.3;"></i>
                        <p class="mb-0">Nenhum follow-up pendente</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Dashboard-specific styles */
    .activity-item {
        display: flex;
        align-items: flex-start;
        padding: 16px;
        border-radius: var(--dev-radius-md);
        background: var(--dev-bg-secondary);
        margin-bottom: 12px;
        border: 1px solid var(--dev-border-color);
        transition: var(--dev-transition-base);
    }

    .activity-item:hover {
        border-color: var(--dev-accent-primary);
        transform: translateX(5px);
    }

    .activity-item:last-child {
        margin-bottom: 0;
    }

    .activity-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--dev-radius-sm);
        margin-right: 16px;
        flex-shrink: 0;
    }

    .activity-content {
        flex: 1;
    }

    .activity-title {
        font-weight: 600;
        margin-bottom: 4px;
    }

    .activity-time {
        font-size: 0.8rem;
        color: var(--dev-text-muted);
    }

    .tip-card {
        padding: 16px;
        background: var(--dev-bg-secondary);
        border-radius: var(--dev-radius-md);
        border: 1px solid var(--dev-border-color);
        margin-bottom: 12px;
        transition: var(--dev-transition-base);
    }

    .tip-card:hover {
        border-color: var(--dev-accent-warning);
    }

    .tip-card:last-child {
        margin-bottom: 0;
    }

    .tip-tag {
        display: inline-block;
        padding: 4px 10px;
        background: rgba(245, 158, 11, 0.1);
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--dev-accent-warning);
        margin-bottom: 8px;
    }

    .followup-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px;
        background: var(--dev-bg-secondary);
        border-radius: var(--dev-radius-md);
        border: 1px solid var(--dev-border-color);
        margin-bottom: 12px;
    }

    .followup-item:last-child {
        margin-bottom: 0;
    }

    .followup-priority-high {
        border-left: 3px solid var(--dev-accent-danger);
    }

    .followup-priority-normal {
        border-left: 3px solid var(--dev-accent-tertiary);
    }
</style>

<script>
    (async () => {
        try {
            // Fetch all data in parallel
            const [patients, formulas, tips] = await Promise.all([
                window.healthTechService.getPatients(),
                window.healthTechService.getFormulas(),
                window.healthTechService.getHealthTips()
            ]);

            // Update stats
            document.getElementById('total-patients').textContent = Array.isArray(patients) ? patients.length : 0;

            const formulaList = formulas.data || formulas;
            document.getElementById('total-formulas').textContent = Array.isArray(formulaList) ? formulaList.length : 0;

            // Consultations (mock for now)
            document.getElementById('total-consultations').textContent = '0';
            document.getElementById('today-consultations').textContent = '0';

            // Tips
            const tipsContainer = document.getElementById('tips-container');
            if (tips && tips.length > 0) {
                tipsContainer.innerHTML = tips.slice(0, 3).map(tip => `
                    <div class="tip-card">
                        <span class="tip-tag">${tip.tag || 'Geral'}</span>
                        <p class="mb-0 text-secondary small">${tip.text}</p>
                    </div>
                `).join('');
            } else {
                tipsContainer.innerHTML = '<p class="text-muted small mb-0">Nenhuma dica disponível</p>';
            }

            // Recent Activities (mock data for now)
            const activitiesContainer = document.getElementById('recent-activities');
            const mockActivities = [
                { type: 'patient', icon: 'bi-person-plus', color: 'primary', title: 'Novo paciente cadastrado', time: 'Há 2 horas' },
                { type: 'formula', icon: 'bi-capsule', color: 'success', title: 'Fórmula enviada para produção', time: 'Há 3 horas' },
                { type: 'consultation', icon: 'bi-clipboard-check', color: 'info', title: 'Consulta farmacêutica concluída', time: 'Há 5 horas' }
            ];

            if (patients.length === 0 && formulaList.length === 0) {
                activitiesContainer.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-inbox fs-1 mb-3 d-block gradient-text" style="opacity: 0.5;"></i>
                        <p class="text-secondary mb-3">Nenhuma atividade ainda</p>
                        <a href="/healthtech-patients#new" class="dev-btn dev-btn-primary">
                            <i class="bi bi-plus-lg"></i> Cadastrar primeiro paciente
                        </a>
                    </div>
                `;
            } else {
                // Show recent patients as activities
                const recentPatients = patients.slice(0, 5);
                activitiesContainer.innerHTML = recentPatients.map(p => `
                    <div class="activity-item">
                        <div class="activity-icon" style="background: rgba(59, 130, 246, 0.1);">
                            <i class="bi bi-person-fill" style="color: var(--dev-accent-primary);"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">${p.name}</div>
                            <div class="activity-time">
                                <i class="bi bi-clock me-1"></i>
                                Cadastrado em ${new Date(p.createdAt).toLocaleDateString('pt-BR')}
                            </div>
                        </div>
                        <span class="badge ${p.lgpdConsent ? 'bg-success' : 'bg-danger'} bg-opacity-10 ${p.lgpdConsent ? 'text-success' : 'text-danger'}">
                            ${p.lgpdConsent ? 'LGPD OK' : 'LGPD Pendente'}
                        </span>
                    </div>
                `).join('');
            }

        } catch (error) {
            console.error('Dashboard error:', error);
            window.core.toast('Erro ao carregar dados do dashboard', 'error');
        }
    })();

    function openNewConsultation() {
        window.core.toast('Funcionalidade em desenvolvimento', 'warning');
    }
</script>