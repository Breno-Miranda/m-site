<section class="dev-section pt-5 mt-5">
    <div class="container">
        <div class="dev-section-header text-center mb-5">
            <span class="dev-section-badge bg-gradient-primary">
                <i class="bi bi-grid-1x2-fill"></i> Meus Aplicativos
            </span>
            <h2 class="dev-section-title">My Apps</h2>
            <p class="dev-section-description">
                Seus aplicativos instalados e ferramentas gratuitas em um só lugar.
            </p>
        </div>

        <!-- Quick Stats for logged user -->
        <div id="user-stats" class="row g-3 mb-5" style="display: none;">
            <div class="col-md-4">
                <div class="card bg-dark border-0 h-100"
                    style="background: linear-gradient(145deg, rgba(30, 30, 45, 0.9), rgba(20, 20, 35, 0.95)) !important; border: 1px solid rgba(59, 130, 246, 0.2) !important; border-radius: 12px;">
                    <div class="card-body d-flex align-items-center gap-3">
                        <div class="bg-primary bg-opacity-25 rounded-3 p-3">
                            <i class="bi bi-box-seam fs-3 text-primary"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-0">Apps Instalados</h6>
                            <h3 class="text-white mb-0" id="stat-installed">0</h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-dark border-0 h-100"
                    style="background: linear-gradient(145deg, rgba(30, 30, 45, 0.9), rgba(20, 20, 35, 0.95)) !important; border: 1px solid rgba(16, 185, 129, 0.2) !important; border-radius: 12px;">
                    <div class="card-body d-flex align-items-center gap-3">
                        <div class="bg-success bg-opacity-25 rounded-3 p-3">
                            <i class="bi bi-bag-check fs-3 text-success"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-0">Apps Comprados</h6>
                            <h3 class="text-white mb-0" id="stat-purchased">0</h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-dark border-0 h-100"
                    style="background: linear-gradient(145deg, rgba(30, 30, 45, 0.9), rgba(20, 20, 35, 0.95)) !important; border: 1px solid rgba(245, 158, 11, 0.2) !important; border-radius: 12px;">
                    <div class="card-body d-flex align-items-center gap-3">
                        <div class="bg-warning bg-opacity-25 rounded-3 p-3">
                            <i class="bi bi-arrow-repeat fs-3 text-warning"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-0">Assinaturas Ativas</h6>
                            <h3 class="text-white mb-0" id="stat-subscriptions">0</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Free Tools Section -->
        <div class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="text-white mb-0">
                    <i class="bi bi-gift-fill text-success me-2"></i>Ferramentas Gratuitas
                </h4>
                <span
                    class="badge bg-success bg-opacity-25 text-success border border-success border-opacity-25 px-3 py-2">
                    <i class="bi bi-infinity"></i> Uso Ilimitado
                </span>
            </div>

            <div class="row g-4" id="free-apps-grid">
                <!-- Password Generator -->
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <div class="dev-skill-card h-100 p-4 position-relative app-item" data-tool="password-gen"
                        style="cursor: pointer;">
                        <span
                            class="position-absolute top-0 end-0 m-3 badge bg-success rounded-pill d-none installed-badge">
                            <i class="bi bi-check-lg"></i>
                        </span>
                        <div class="dev-skill-icon mb-3">
                            <i class="bi bi-key fs-1 text-primary"></i>
                        </div>
                        <h5 class="dev-skill-title mb-2">Gerador de Senha</h5>
                        <p class="text-muted small mb-0">Senhas fortes e seguras</p>
                    </div>
                </div>

                <!-- Percentage Calculator -->
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <div class="dev-skill-card h-100 p-4 position-relative app-item" data-tool="percentage-calc"
                        style="cursor: pointer;">
                        <span
                            class="position-absolute top-0 end-0 m-3 badge bg-success rounded-pill d-none installed-badge">
                            <i class="bi bi-check-lg"></i>
                        </span>
                        <div class="dev-skill-icon mb-3">
                            <i class="bi bi-percent fs-1 text-success"></i>
                        </div>
                        <h5 class="dev-skill-title mb-2">Calculadora %</h5>
                        <p class="text-muted small mb-0">Cálculos rápidos</p>
                    </div>
                </div>

                <!-- CPF/CNPJ Generator -->
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <div class="dev-skill-card h-100 p-4 position-relative app-item" data-tool="doc-gen"
                        style="cursor: pointer;">
                        <span
                            class="position-absolute top-0 end-0 m-3 badge bg-success rounded-pill d-none installed-badge">
                            <i class="bi bi-check-lg"></i>
                        </span>
                        <div class="dev-skill-icon mb-3">
                            <i class="bi bi-person-badge fs-1 text-info"></i>
                        </div>
                        <h5 class="dev-skill-title mb-2">Gerador CPF/CNPJ</h5>
                        <p class="text-muted small mb-0">Documentos para testes</p>
                    </div>
                </div>

                <!-- NFe XML to JSON -->
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <div class="dev-skill-card h-100 p-4 position-relative app-item" data-tool="nfe-xml-json"
                        style="cursor: pointer;">
                        <span
                            class="position-absolute top-0 end-0 m-3 badge bg-success rounded-pill d-none installed-badge">
                            <i class="bi bi-check-lg"></i>
                        </span>
                        <div class="dev-skill-icon mb-3">
                            <i class="bi bi-file-earmark-code fs-1 text-warning"></i>
                        </div>
                        <h5 class="dev-skill-title mb-2">XML NFe → JSON</h5>
                        <p class="text-muted small mb-0">Conversão instantânea</p>
                    </div>
                </div>

                <!-- JSON Formatter -->
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <div class="dev-skill-card h-100 p-4 position-relative app-item" data-tool="json-formatter"
                        style="cursor: pointer;">
                        <span
                            class="position-absolute top-0 end-0 m-3 badge bg-success rounded-pill d-none installed-badge">
                            <i class="bi bi-check-lg"></i>
                        </span>
                        <div class="dev-skill-icon mb-3">
                            <i class="bi bi-braces fs-1 text-danger"></i>
                        </div>
                        <h5 class="dev-skill-title mb-2">JSON Formatter</h5>
                        <p class="text-muted small mb-0">Valide e formate</p>
                    </div>
                </div>

                <!-- Base64 Converter -->
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <div class="dev-skill-card h-100 p-4 position-relative app-item" data-tool="base64-converter"
                        style="cursor: pointer;">
                        <span
                            class="position-absolute top-0 end-0 m-3 badge bg-success rounded-pill d-none installed-badge">
                            <i class="bi bi-check-lg"></i>
                        </span>
                        <div class="dev-skill-icon mb-3">
                            <i class="bi bi-shield-lock fs-1 text-light"></i>
                        </div>
                        <h5 class="dev-skill-title mb-2">Base64 Converter</h5>
                        <p class="text-muted small mb-0">Encode & Decode</p>
                    </div>
                </div>

                <!-- De/Para Universal -->
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <div class="dev-skill-card h-100 p-4 position-relative app-item" data-tool="depara-transform"
                        style="cursor: pointer;">
                        <span
                            class="position-absolute top-0 end-0 m-3 badge bg-success rounded-pill d-none installed-badge">
                            <i class="bi bi-check-lg"></i>
                        </span>
                        <div class="dev-skill-icon mb-3">
                            <i class="bi bi-arrow-left-right fs-1 text-info"></i>
                        </div>
                        <h5 class="dev-skill-title mb-2">De/Para Universal</h5>
                        <p class="text-muted small mb-0">Mapeamento em massa</p>
                    </div>
                </div>

                <!-- View All Apps -->
                <div class="col-lg-3 col-md-4 col-sm-6">
                    <a href="/apps" class="text-decoration-none">
                        <div class="dev-skill-card h-100 p-4 text-center d-flex flex-column justify-content-center"
                            style="border: 2px dashed rgba(255,255,255,0.1); cursor: pointer;">
                            <div class="dev-skill-icon mb-3">
                                <i class="bi bi-plus-circle fs-1 text-muted"></i>
                            </div>
                            <h5 class="dev-skill-title mb-2 text-muted">Ver Todos</h5>
                            <p class="text-muted small mb-0">Explorar ferramentas</p>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- Purchased/Premium Apps Section -->
        <div id="purchased-apps-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="text-white mb-0">
                    <i class="bi bi-star-fill text-warning me-2"></i>Apps Adquiridos
                </h4>
                <a href="/marketplace" class="btn btn-outline-primary btn-sm rounded-pill">
                    <i class="bi bi-shop"></i> Ver Marketplace
                </a>
            </div>

            <div class="row g-4" id="purchased-apps-grid">
                <!-- Purchased apps will be injected here -->
            </div>
        </div>

        <!-- Empty State for logged out users needing premium apps -->
        <div id="login-cta" class="text-center py-5 my-4">
            <div class="card bg-dark border-0 p-5"
                style="background: linear-gradient(145deg, rgba(30, 30, 45, 0.9), rgba(20, 20, 35, 0.95)) !important; border: 1px solid rgba(59, 130, 246, 0.1) !important; border-radius: 16px;">
                <div class="display-1 text-primary mb-4">
                    <i class="bi bi-person-circle"></i>
                </div>
                <h4 class="text-white mb-3">Faça login para desbloquear mais recursos</h4>
                <p class="text-muted mb-4">
                    Acesse sua conta para ver seus apps comprados, histórico de uso e recursos premium.
                </p>
                <div class="d-flex gap-3 justify-content-center">
                    <a href="/login" class="btn btn-primary px-4">
                        <i class="bi bi-box-arrow-in-right me-2"></i>Entrar
                    </a>
                    <a href="/marketplace" class="btn btn-outline-light px-4">
                        <i class="bi bi-shop me-2"></i>Ver Marketplace
                    </a>
                </div>
            </div>
        </div>

    </div>
</section>

<style>
    .dev-skill-card {
        background: linear-gradient(145deg, rgba(30, 30, 45, 0.9), rgba(20, 20, 35, 0.95));
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 16px;
        transition: all 0.3s ease;
    }

    .dev-skill-card:hover {
        transform: translateY(-5px);
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(59, 130, 246, 0.3);
    }

    .app-item:hover .dev-skill-icon i {
        transform: scale(1.1);
        transition: transform 0.3s ease;
    }

    .purchased-card {
        background: linear-gradient(145deg, rgba(30, 30, 45, 0.9), rgba(20, 20, 35, 0.95)) !important;
        border: 1px solid rgba(245, 158, 11, 0.2) !important;
        border-radius: 16px !important;
        transition: all 0.3s ease;
    }

    .purchased-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
    }
</style>

<script>
    (function () {
        const auth = window.authService;

        function init() {
            updateUIForAuth();
            bindToolClicks();

            // Listen for auth changes
            window.addEventListener('auth-change', updateUIForAuth);
        }

        function updateUIForAuth() {
            const userStats = document.getElementById('user-stats');
            const purchasedSection = document.getElementById('purchased-apps-section');
            const loginCta = document.getElementById('login-cta');

            if (auth && auth.isAuthenticated()) {
                userStats.style.display = 'flex';
                purchasedSection.style.display = 'block';
                loginCta.style.display = 'none';

                loadUserStats();
                loadPurchasedApps();
            } else {
                userStats.style.display = 'none';
                purchasedSection.style.display = 'none';
                loginCta.style.display = 'block';
            }

            updateInstalledBadges();
        }

        // Cache for catalog data
        let catalogData = {};

        async function fetchCatalog() {
            try {
                const res = await window.core.fetchAPI('/catalog', 'GET');
                if (res && res.success) {
                    // Index by appKey
                    res.data.forEach(item => {
                        catalogData[item.appKey] = item;
                    });
                    return res.data;
                }
                return [];
            } catch (err) {
                console.error('Error fetching catalog:', err);
                return [];
            }
        }



        async function fetchUserApps() {
            try {
                const user = auth.getUser();
                if (!user || !user.id) return [];

                const res = await window.core.fetchAPI(`/apps?userId=${user.id}`, 'GET');
                if (res && res.success) {
                    return res.data;
                }
                return [];
            } catch (err) {
                console.error('Error fetching apps:', err);
                return [];
            }
        }

        async function loadUserStats() {
            // 1. Ensure catalog is loaded
            await fetchCatalog();

            // 2. Get User Apps
            const apps = await fetchUserApps();

            // 3. Enrich apps with catalog data
            const enrichedApps = apps.map(app => {
                const meta = catalogData[app.appKey] || { type: 'free' };
                return { ...app, ...meta }; // Merge
            });

            // 4. Calculate Stats
            const purchased = enrichedApps.filter(app => app.type === 'one-time' || app.type === 'subscription');
            const subscriptions = enrichedApps.filter(app => app.type === 'subscription');

            document.getElementById('stat-installed').textContent = enrichedApps.length;
            document.getElementById('stat-purchased').textContent = purchased.length;
            document.getElementById('stat-subscriptions').textContent = subscriptions.length;

            return enrichedApps; // Pass enriched data down
        }

        async function loadPurchasedApps() {
            // loadUserStats handles fetching and enriching, but we need the result.
            // We can just re-fetch since loadUserStats populates cache, or modify flow to chain.
            // Better: call loadUserStats which returns enrichedApps.
            const enrichedApps = await loadUserStats();

            const grid = document.getElementById('purchased-apps-grid');

            // Filter for premium based on the enriched data
            const purchasedApps = enrichedApps.filter(app => {
                return app.type === 'subscription' || app.type === 'one-time';
            });

            if (purchasedApps.length === 0) {
                grid.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-secondary bg-dark border-secondary text-center py-4">
                            <i class="bi bi-inbox fs-2 d-block mb-2"></i>
                            Você ainda não adquiriu nenhum app premium.
                            <a href="/marketplace" class="text-primary">Explorar Marketplace</a>
                        </div>
                    </div>
                `;
                return;
            }

            grid.innerHTML = purchasedApps.map(app => {
                // Use data from catalog (merged into app)
                const isSub = app.type === 'subscription';
                const icon = app.icon || 'bi-box';

                return `
                <div class="col-lg-4 col-md-6">
                    <div class="card purchased-card h-100">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="app-icon bg-warning bg-opacity-25 rounded-3 p-3">
                                    <i class="bi ${icon} fs-2 text-warning"></i>
                                </div>
                                <span class="badge bg-${isSub ? 'primary' : 'success'} bg-opacity-25 text-${isSub ? 'primary' : 'success'}">
                                    <i class="bi bi-${isSub ? 'arrow-repeat' : 'bag-check'}"></i>
                                    ${isSub ? 'Ativo' : 'Comprado'}
                                </span>
                            </div>
                            <h5 class="card-title text-white fw-bold mb-2">${app.name}</h5>
                            <p class="card-text text-muted small mb-3">${app.description || ''}</p>
                            <button class="btn btn-outline-light btn-sm w-100" onclick="window.core.toast('Launch App: ${app.appKey}', 'info')">
                                <i class="bi bi-box-arrow-up-right"></i> Abrir
                            </button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        function updateInstalledBadges() {
            const installedApps = JSON.parse(localStorage.getItem('msoft_installed_apps') || '[]');

            document.querySelectorAll('.app-item').forEach(item => {
                const toolId = item.dataset.tool;
                const badge = item.querySelector('.installed-badge');

                if (installedApps.includes(toolId) && badge) {
                    badge.classList.remove('d-none');
                }
            });
        }

        function bindToolClicks() {
            document.querySelectorAll('.app-item').forEach(item => {
                item.addEventListener('click', function () {
                    const toolId = this.dataset.tool;
                    if (toolId) {
                        // Navigate to apps page with the tool pre-selected
                        window.location.href = `/apps?tool=${toolId}`;
                    }
                });
            });
        }

        // Init on DOM ready or immediately if already loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    })();
</script>