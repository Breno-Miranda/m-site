<!-- MCredential - Password Manager Page -->
<!-- Version: V0.10.26 -->

<link rel="stylesheet" href="/src/assets/css/mcredential.css">

<!-- Main Wrapper -->
<div class="mcredential-wrapper">
    <!-- Login Screen -->
    <div id="mcred-login-screen" class="login-screen" style="display: none !important;">
        <div class="login-container">
            <div class="login-logo">
                <i class="bi bi-shield-lock-fill"></i>
            </div>
            <h1 id="mcred-login-title" class="login-title">MCredential</h1>
            <p id="mcred-login-subtitle" class="login-subtitle">Seu cofre de senhas seguro</p>

            <form id="mcred-login-form" class="login-form">
                <div class="form-group">
                    <label for="mcred-master-password">Senha Mestra</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="mcred-master-password" class="form-input"
                            placeholder="Digite sua senha mestra" autocomplete="current-password" required>
                        <button type="button" class="password-toggle" data-target="mcred-master-password">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                </div>

                <div id="mcred-confirm-password-group" class="form-group" style="display: none;">
                    <label for="mcred-confirm-password">Confirmar Senha</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="mcred-confirm-password" class="form-input"
                            placeholder="Confirme sua senha mestra" autocomplete="new-password">
                        <button type="button" class="password-toggle" data-target="mcred-confirm-password">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                </div>

                <button type="submit" id="mcred-login-button" class="btn btn-primary btn-full">
                    <i class="bi bi-unlock"></i> Desbloquear
                </button>
            </form>

            <div class="text-center mt-4">
                <a href="/premium" class="btn btn-secondary btn-sm">
                    <i class="bi bi-arrow-left"></i> Voltar ao Hub
                </a>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div id="mcred-app-container" class="app-container" style="display: block !important;">
        <!-- Header -->
        <header class="app-header">
            <div class="header-logo">
                <i class="bi bi-shield-lock-fill"></i>
                <span class="gradient-text">MCredential</span>
            </div>
            <div class="header-actions">
                <button id="mcred-add-button" class="btn btn-primary btn-sm">
                    <i class="bi bi-plus-lg"></i> Nova Senha
                </button>
                <a href="/premium" class="btn btn-secondary btn-sm btn-icon" title="Voltar ao Hub">
                    <i class="bi bi-grid"></i>
                </a>
                <button id="mcred-logout-button" class="btn btn-secondary btn-sm btn-icon" title="Bloquear">
                    <i class="bi bi-lock"></i>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="app-main">
            <!-- Search & Filters -->
            <section class="search-section">
                <div class="search-wrapper">
                    <i class="bi bi-search"></i>
                    <input type="text" id="mcred-search-input" class="search-input" placeholder="Buscar credenciais...">
                </div>
                <div id="mcred-category-filter" class="category-filter">
                    <!-- Categories will be rendered here -->
                </div>
            </section>

            <!-- Loading Spinner -->
            <div id="mcred-loading" class="loading-spinner hidden">
                <div class="spinner"></div>
            </div>

            <!-- Credentials Grid -->
            <div id="mcred-credentials-grid" class="credentials-grid">
                <!-- Credentials will be rendered here -->
            </div>
        </main>
    </div>

    <!-- Credential Modal -->
    <div id="mcred-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 id="mcred-modal-title" class="modal-title">Nova Credencial</h3>
                <button id="mcred-modal-close" class="modal-close">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="mcred-credential-form">
                    <div class="form-group">
                        <label for="mcred-json-editor">Editor JSON</label>
                        <textarea id="mcred-json-editor" class="form-input" rows="15"
                            style="font-family: 'Courier New', Courier, monospace; font-size: 0.85rem; background: #1a1a1a; color: #00ff00; border-color: #333;"
                            placeholder='{ "title": "Example", ... }'></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="mcred-delete-credential" class="btn btn-danger btn-sm" style="display: none;">
                    <i class="bi bi-trash"></i>
                </button>
                <button type="button" id="mcred-modal-cancel" class="btn btn-secondary">Cancelar</button>
                <button type="submit" form="mcred-credential-form" class="btn btn-primary">
                    <i class="bi bi-check2"></i> Salvar
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="mcred-toast-container" class="toast-container"></div>
</div>

<script>
    /**
     * MCredential - Crypto Module (Inline for Msite)
     * Version: V0.10.11
     */
    const MCryptoModule = (function () {
        const ALGORITHM = 'AES-GCM';
        const KEY_LENGTH = 256;
        const ITERATIONS = 100000;
        const SALT_LENGTH = 16;
        const IV_LENGTH = 12;

        function generateRandomBytes(length) {
            return crypto.getRandomValues(new Uint8Array(length));
        }

        function bufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        function base64ToBuffer(base64) {
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes;
        }

        async function deriveKey(password, salt) {
            const encoder = new TextEncoder();
            const passwordBuffer = encoder.encode(password);

            const keyMaterial = await crypto.subtle.importKey(
                'raw', passwordBuffer, { name: 'PBKDF2' }, false, ['deriveBits', 'deriveKey']
            );

            return crypto.subtle.deriveKey(
                { name: 'PBKDF2', salt: salt, iterations: ITERATIONS, hash: 'SHA-256' },
                keyMaterial,
                { name: ALGORITHM, length: KEY_LENGTH },
                false,
                ['encrypt', 'decrypt']
            );
        }

        async function encrypt(plaintext, masterPassword) {
            const encoder = new TextEncoder();
            const data = encoder.encode(plaintext);

            const salt = generateRandomBytes(SALT_LENGTH);
            const iv = generateRandomBytes(IV_LENGTH);
            const key = await deriveKey(masterPassword, salt);

            const encrypted = await crypto.subtle.encrypt(
                { name: ALGORITHM, iv: iv }, key, data
            );

            return {
                salt: bufferToBase64(salt),
                iv: bufferToBase64(iv),
                data: bufferToBase64(encrypted)
            };
        }

        async function decrypt(encryptedObj, masterPassword) {
            try {
                const salt = base64ToBuffer(encryptedObj.salt);
                const iv = base64ToBuffer(encryptedObj.iv);
                const data = base64ToBuffer(encryptedObj.data);

                const key = await deriveKey(masterPassword, salt);
                const decrypted = await crypto.subtle.decrypt(
                    { name: ALGORITHM, iv: iv }, key, data
                );

                const decoder = new TextDecoder();
                return decoder.decode(decrypted);
            } catch (error) {
                return null;
            }
        }

        async function hashPassword(password, salt) {
            const key = await deriveKey(password, salt);
            const exported = await crypto.subtle.exportKey('raw', key);
            return bufferToBase64(exported);
        }

        function generatePassword(options = {}) {
            const { length = 16, uppercase = true, lowercase = true, numbers = true, symbols = true } = options;

            let chars = '';
            if (uppercase) chars += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            if (lowercase) chars += 'abcdefghijklmnopqrstuvwxyz';
            if (numbers) chars += '0123456789';
            if (symbols) chars += '!@#$%^&*()_+-=[]{}|;:,.<>?';
            if (!chars) chars = 'abcdefghijklmnopqrstuvwxyz0123456789';

            const randomBytes = generateRandomBytes(length);
            let password = '';
            for (let i = 0; i < length; i++) {
                password += chars[randomBytes[i] % chars.length];
            }
            return password;
        }

        return { encrypt, decrypt, hashPassword, generatePassword, generateRandomBytes, bufferToBase64, base64ToBuffer };
    })();

    /**
     * MCredential - API Service Module
     * Integrates with Mmanage backend
     */
    const MApiService = (function () {
        const API_BASE = 'http://localhost:3000'; // Mmanage backend

        async function fetchCredentials() {
            try {
                const userStr = localStorage.getItem('msoft_user_data');
                const user = userStr ? JSON.parse(userStr) : null;
                const userId = user ? (user.id || user._id) : null;

                let endpoint = userId
                    ? `/credentials?limit=100&rule=movida&userId=${userId}`
                    : `/credentials?limit=100`;

                const data = await window.core.fetchAPI(endpoint, 'GET');

                if (data.success && Array.isArray(data.data)) {
                    return data.data.map(item => {
                        // Data can be in item.document.password or directly in item
                        const p = item.document?.password || item;

                        // Map legacy categories to frontend IDs
                        let category = p.category || item.category || 'outros';
                        if (category === 'work') category = 'trabalho';
                        if (category === 'personal') category = 'pessoal';
                        if (category === 'finance') category = 'financeiro';
                        if (category === 'social_media') category = 'social';

                        return {
                            ...item,
                            id: item.id || item._id || (typeof p.id === 'object' ? p.id.$numberLong : p.id),
                            username: p.username || item.username || item.email || '',
                            title: p.siteName || item.title || item.siteName || item.service || 'Sem Título',
                            password: p.passwordEncrypted || item.password || item.passwordEncrypted || '',
                            url: p.siteUrl || item.url || '',
                            category: category,
                            notes: p.notes || item.notes || ''
                        };
                    });
                }
                return [];
            } catch (error) {
                console.error('Error fetching credentials:', error);
                return [];
            }
        }

        async function createCredential(credential) {
            try {
                return await window.core.fetchAPI('/credentials', 'POST', credential);
            } catch (error) {
                console.error('Error creating credential:', error);
                return { success: false, error: error.message };
            }
        }

        async function updateCredential(id, credential) {
            try {
                return await window.core.fetchAPI(`/credentials/${id}`, 'PUT', credential);
            } catch (error) {
                console.error('Error updating credential:', error);
                return { success: false, error: error.message };
            }
        }

        async function deleteCredential(id) {
            try {
                return await window.core.fetchAPI(`/credentials/${id}`, 'DELETE');
            } catch (error) {
                console.error('Error deleting credential:', error);
                return { success: false, error: error.message };
            }
        }

        return { fetchCredentials, createCredential, updateCredential, deleteCredential };
    })();

    /**
     * MCredential - Storage Module (Hybrid: API + LocalStorage)
     */
    const MStorageModule = (function () {
        const STORAGE_KEYS = {
            SALT: 'mcredential_salt',
            HASH: 'mcredential_hash',
            INITIALIZED: 'mcredential_initialized'
        };

        function isInitialized() {
            return localStorage.getItem(STORAGE_KEYS.INITIALIZED) === 'true';
        }

        async function initialize(masterPassword) {
            const salt = MCryptoModule.generateRandomBytes(16);
            const hash = await MCryptoModule.hashPassword(masterPassword, salt);

            localStorage.setItem(STORAGE_KEYS.SALT, MCryptoModule.bufferToBase64(salt));
            localStorage.setItem(STORAGE_KEYS.HASH, hash);
            localStorage.setItem(STORAGE_KEYS.INITIALIZED, 'true');
            return true;
        }

        async function verifyPassword(masterPassword) {
            if (!isInitialized()) return false;

            const saltBase64 = localStorage.getItem(STORAGE_KEYS.SALT);
            const storedHash = localStorage.getItem(STORAGE_KEYS.HASH);
            if (!saltBase64 || !storedHash) return false;

            const salt = MCryptoModule.base64ToBuffer(saltBase64);
            const hash = await MCryptoModule.hashPassword(masterPassword, salt);
            return hash === storedHash;
        }

        // Load credentials from API
        async function loadVault() {
            return await MApiService.fetchCredentials();
        }

        // Save credential to API
        async function saveCredential(credential) {
            if (credential.id) {
                return await MApiService.updateCredential(credential.id, credential);
            } else {
                return await MApiService.createCredential(credential);
            }
        }

        // Delete credential from API
        async function deleteCredential(id) {
            return await MApiService.deleteCredential(id);
        }

        return { isInitialized, initialize, verifyPassword, loadVault, saveCredential, deleteCredential };
    })();

    /**
     * MCredential - Main Application
     */
    const MCredApp = (function () {
        let credentials = [];
        let masterPassword = null;
        let currentCredentialId = null;
        let currentFilter = 'all';
        let searchQuery = '';

        const categories = [
            { id: 'all', name: 'Todos', icon: 'bi-grid' },
            { id: 'trabalho', name: 'Trabalho', icon: 'bi-briefcase' },
            { id: 'pessoal', name: 'Pessoal', icon: 'bi-person' },
            { id: 'financeiro', name: 'Financeiro', icon: 'bi-bank' },
            { id: 'social', name: 'Redes Sociais', icon: 'bi-share' },
            { id: 'outros', name: 'Outros', icon: 'bi-folder' }
        ];

        const el = {};

        function init() {
            cacheElements();
            bindEvents();
            // Bypass login screen - user is already authenticated
            loadCredentialsFromAPI();
            showApp();
        }

        function cacheElements() {
            el.loginScreen = document.getElementById('mcred-login-screen');
            el.loginForm = document.getElementById('mcred-login-form');
            el.appContainer = document.getElementById('mcred-app-container');
            el.categoryFilter = document.getElementById('mcred-category-filter');
            el.credentialsGrid = document.getElementById('mcred-credentials-grid');
            el.modal = document.getElementById('mcred-modal');
            el.modalTitle = document.getElementById('mcred-modal-title');
            el.credentialForm = document.getElementById('mcred-credential-form');
            el.toastContainer = document.getElementById('mcred-toast-container');
            el.searchInput = document.getElementById('mcred-search-input');
            el.jsonEditor = document.getElementById('mcred-json-editor');
        }

        function bindEvents() {
            // Login (Deprecated but kept to prevent errors if manually triggered)
            if (el.loginForm) {
                el.loginForm.addEventListener('submit', handleLogin);
            }

            // Header Actions
            document.getElementById('mcred-add-button')?.addEventListener('click', () => openModal());
            document.getElementById('mcred-logout-button')?.addEventListener('click', logout);

            // Search
            el.searchInput?.addEventListener('input', (e) => {
                searchQuery = e.target.value.toLowerCase();
                renderCredentials();
            });

            // Modal Actions
            document.getElementById('mcred-modal-close')?.addEventListener('click', closeModal);
            document.getElementById('mcred-modal-cancel')?.addEventListener('click', closeModal);
            el.credentialForm?.addEventListener('submit', handleSaveCredential);
            document.getElementById('mcred-delete-credential')?.addEventListener('click', handleDeleteCredential);

            // Password Visibility Toggles
            document.querySelectorAll('.password-toggle').forEach(btn => {
                btn.addEventListener('click', function () {
                    const targetId = this.dataset.target;
                    const input = document.getElementById(targetId);
                    if (input) {
                        const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                        input.setAttribute('type', type);
                        this.querySelector('i').classList.toggle('bi-eye');
                        this.querySelector('i').classList.toggle('bi-eye-slash');
                    }
                });
            });

            // Delegated click listener for credential cards
            el.credentialsGrid?.addEventListener('click', (e) => {
                const actionBtn = e.target.closest('.action-btn');
                if (actionBtn) {
                    const id = actionBtn.dataset.id;
                    const action = actionBtn.dataset.action;
                    if (action === 'open') {
                        openModal(id);
                    }
                }

                const copyBtn = e.target.closest('.copy-btn');
                if (copyBtn) {
                    const text = copyBtn.dataset.text;
                    copyToClipboard(text, copyBtn);
                }

                // Toggle password visibility
                const toggleBtn = e.target.closest('.toggle-password-btn');
                if (toggleBtn) {
                    const passwordField = toggleBtn.closest('.credential-field').querySelector('.field-password');
                    const realPassword = toggleBtn.dataset.password;
                    const icon = toggleBtn.querySelector('i');

                    if (toggleBtn.classList.contains('showing')) {
                        // Hide password
                        passwordField.textContent = '••••••••';
                        icon.classList.replace('bi-eye-slash', 'bi-eye');
                        toggleBtn.classList.remove('showing');
                    } else {
                        // Show password
                        passwordField.textContent = realPassword;
                        icon.classList.replace('bi-eye', 'bi-eye-slash');
                        toggleBtn.classList.add('showing');

                        // Auto-hide after 5 seconds
                        setTimeout(() => {
                            if (toggleBtn.classList.contains('showing')) {
                                passwordField.textContent = '••••••••';
                                icon.classList.replace('bi-eye-slash', 'bi-eye');
                                toggleBtn.classList.remove('showing');
                            }
                        }, 5000);
                    }
                }
            });
        }

        function checkInitialization() {
            // Deprecated: Login screen is no longer used
            showApp();
        }

        async function handleLogin(e) {
            e.preventDefault();
            // Deprecated: Login logic bypassed
            showApp();
        }

        async function loadCredentialsFromAPI() {
            showLoading(true);
            try {
                credentials = await MStorageModule.loadVault();
                renderCredentials();
            } catch (error) {
                console.error('Error loading credentials:', error);
                showToast('Erro ao carregar credenciais', 'error');
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            const loader = document.getElementById('mcred-loading');
            if (loader) {
                if (show) loader.classList.remove('hidden');
                else loader.classList.add('hidden');
            }
        }

        function showApp() {
            el.loginScreen.classList.add('hidden'); // Force hide
            el.loginScreen.style.display = 'none';
            el.appContainer.classList.add('active');
            renderCategories();
            renderCredentials();
        }

        function logout() {
            // Redirect to main logout or simple reload
            // For now, just reload the list
            loadCredentialsFromAPI();
            showToast('Dados atualizados', 'success');
        }

        function renderCategories() {
            el.categoryFilter.innerHTML = categories.map(cat => `
            <button class="category-btn ${cat.id === currentFilter ? 'active' : ''}" data-category="${cat.id}">
                <i class="bi ${cat.icon}"></i> ${cat.name}
            </button>
        `).join('');

            el.categoryFilter.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentFilter = btn.dataset.category;
                    el.categoryFilter.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderCredentials();
                });
            });
        }

        function renderCredentials() {
            let filtered = credentials;
            if (currentFilter !== 'all') filtered = filtered.filter(c => c.category === currentFilter);
            if (searchQuery) {
                filtered = filtered.filter(c =>
                    (c.title && c.title.toLowerCase().includes(searchQuery)) ||
                    (c.username && c.username.toLowerCase().includes(searchQuery)) ||
                    (c.url && c.url.toLowerCase().includes(searchQuery)) ||
                    (c.service && c.service.toLowerCase().includes(searchQuery))
                );
            }

            if (filtered.length === 0) {
                el.credentialsGrid.innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1;">
                    <div class="empty-icon"><i class="bi bi-shield-lock"></i></div>
                    <h3 class="empty-title">Nenhuma credencial encontrada</h3>
                    <p class="empty-description">${credentials.length === 0 ? 'Adicione sua primeira senha' : 'Ajuste os filtros'}</p>
                    ${credentials.length === 0 ? '<button class="btn btn-primary" onclick="MCredApp.openModal()"><i class="bi bi-plus-lg"></i> Adicionar</button>' : ''}
                </div>
            `;
                return;
            }

            el.credentialsGrid.innerHTML = filtered.map(cred => `
            <div class="credential-card" data-id="${cred.id}">
                <div class="credential-header">
                    <div class="credential-info">
                        <div class="credential-icon"><i class="bi ${getCategoryIcon(cred.category)}"></i></div>
                        <div>
                            <h4 class="credential-title">${escapeHtml(cred.title || cred.service || 'Sem título')}</h4>
                            <span class="credential-category">${getCategoryName(cred.category)}</span>
                        </div>
                    </div>
                </div>
                <div class="credential-body">
                    ${cred.url ? `<div class="credential-field"><div><div class="field-label">URL</div><div class="field-value">${escapeHtml(truncate(cred.url, 30))}</div></div><button class="copy-btn" data-text="${escapeHtml(cred.url)}"><i class="bi bi-copy"></i></button></div>` : ''}
                    <div class="credential-field"><div><div class="field-label">Usuário</div><div class="field-value">${escapeHtml(cred.username || cred.email || '-')}</div></div><button class="copy-btn" data-text="${escapeHtml(cred.username || cred.email || '')}"><i class="bi bi-copy"></i></button></div>
                    <div class="credential-field">
                        <div><div class="field-label">Senha</div><div class="field-value field-password">••••••••</div></div>
                        <div class="password-actions">
                            <button class="toggle-password-btn" data-password="${escapeHtml(decodePassword(cred.password || ''))}" title="Mostrar/Esconder"><i class="bi bi-eye"></i></button>
                            <button class="copy-btn" data-text="${escapeHtml(decodePassword(cred.password || ''))}"><i class="bi bi-copy"></i></button>
                        </div>
                    </div>
                </div>
                <div class="credential-actions">
                    <button class="btn btn-secondary btn-sm action-btn" data-id="${cred.id}" data-action="open" title="Ver Detalhes">
                        <i class="bi bi-eye"></i> Detalhes
                    </button>
                    <button class="btn btn-secondary btn-sm action-btn" data-id="${cred.id}" data-action="open" title="Editar">
                        <i class="bi bi-pencil"></i>
                    </button>
                </div>
            </div>
        `).join('');
        }

        function openModal(id = null) {
            console.log('Attempting to open modal for ID:', id);

            if (!el.modal) {
                console.error('Modal element not found in cache!');
                el.modal = document.getElementById('mcred-modal');
            }

            currentCredentialId = id;

            if (id) {
                const cred = credentials.find(c => c.id == id);
                if (cred) {
                    el.modalTitle.textContent = 'Editar Credencial (JSON)';
                    const displayData = { ...cred };
                    delete displayData._id;
                    el.jsonEditor.value = JSON.stringify(displayData, null, 4);
                    document.getElementById('mcred-delete-credential').style.display = 'block';
                } else {
                    console.warn('Credential not found for ID:', id);
                    showToast('Erro: Credencial não encontrada', 'error');
                    return;
                }
            } else {
                el.modalTitle.textContent = 'Nova Credencial (JSON)';
                el.jsonEditor.value = JSON.stringify({
                    title: "",
                    username: "",
                    password: "",
                    url: "",
                    category: "pessoal",
                    notes: ""
                }, null, 4);
                document.getElementById('mcred-delete-credential').style.display = 'none';
            }

            if (el.modal) {
                el.modal.classList.add('active');
                console.log('Modal opened successfully');
            } else {
                showToast('Erro crítico: Modal não encontrado', 'error');
            }
        }

        function closeModal() {
            el.modal.classList.remove('active');
            currentCredentialId = null;
            el.credentialForm.reset();
        }

        async function handleSaveCredential(e) {
            e.preventDefault();

            let credentialData;
            try {
                credentialData = JSON.parse(el.jsonEditor.value);
            } catch (err) {
                showToast('JSON Inválido', 'error');
                return;
            }

            if (!credentialData.title || !credentialData.username || !credentialData.password) {
                showToast('JSON deve conter ao menos title, username e password', 'error');
                return;
            }

            // Get user ID
            const userStr = localStorage.getItem('msoft_user_data');
            const user = userStr ? JSON.parse(userStr) : null;
            const userId = user ? (user.id || user._id) : null;

            credentialData.userId = userId;

            showLoading(true);

            if (currentCredentialId) {
                credentialData.id = currentCredentialId;
                const result = await MStorageModule.saveCredential(credentialData);
                if (result.success) {
                    showToast('Credencial atualizada', 'success');
                } else {
                    showToast('Erro ao atualizar credencial', 'error');
                }
            } else {
                const result = await MStorageModule.saveCredential(credentialData);
                if (result.success) {
                    showToast('Credencial adicionada', 'success');
                } else {
                    showToast('Erro ao adicionar credencial', 'error');
                }
            }

            await loadCredentialsFromAPI();
            renderCredentials();
            closeModal();
        }

        async function handleDeleteCredential() {
            if (!currentCredentialId) return;
            if (!confirm('Tem certeza que deseja excluir esta credencial?')) return;

            showLoading(true);
            const result = await MStorageModule.deleteCredential(currentCredentialId);

            if (result.success) {
                showToast('Credencial excluída', 'success');
            } else {
                showToast('Erro ao excluir credencial', 'error');
            }

            await loadCredentialsFromAPI();
            renderCredentials();
            closeModal();
        }

        /* Removed password generator functions as they are no longer used with JSON editor */

        async function copyToClipboard(text, btn) {
            if (!text) {
                showToast('Nada para copiar', 'error');
                return;
            }

            let success = false;

            // Try modern clipboard API first (requires HTTPS or localhost)
            if (navigator.clipboard && window.isSecureContext) {
                try {
                    await navigator.clipboard.writeText(text);
                    success = true;
                } catch (err) {
                    console.warn('Clipboard API failed, trying fallback:', err);
                }
            }

            // Fallback for HTTP contexts using execCommand
            if (!success) {
                try {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed';
                    textarea.style.left = '-9999px';
                    textarea.style.top = '0';
                    textarea.setAttribute('readonly', '');
                    document.body.appendChild(textarea);
                    textarea.select();
                    textarea.setSelectionRange(0, textarea.value.length);
                    success = document.execCommand('copy');
                    document.body.removeChild(textarea);
                } catch (err) {
                    console.error('Fallback copy failed:', err);
                }
            }

            if (success) {
                btn.classList.add('copied');
                const icon = btn.querySelector('i');
                if (icon) {
                    icon.classList.replace('bi-copy', 'bi-check');
                }
                showToast('Copiado!', 'success');
                setTimeout(() => {
                    btn.classList.remove('copied');
                    if (icon) {
                        icon.classList.replace('bi-check', 'bi-copy');
                    }
                }, 2000);
            } else {
                showToast('Erro ao copiar - tente selecionar manualmente', 'error');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="bi ${type === 'success' ? 'bi-check-circle' : 'bi-exclamation-circle'}"></i><span>${message}</span>`;
            el.toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Decode Base64 password and remove salt suffix
        function decodePassword(encodedPassword) {
            if (!encodedPassword) return '';
            try {
                // Try to decode Base64
                const decoded = atob(encodedPassword);
                // Remove the salt suffix if present
                const salt = 'movida_passwords_2024';
                if (decoded.endsWith(salt)) {
                    return decoded.slice(0, -salt.length);
                }
                return decoded;
            } catch (e) {
                // If not valid Base64, return as-is
                return encodedPassword;
            }
        }

        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
        function escapeHtml(text) { if (!text) return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        function truncate(str, maxLength) { if (!str) return ''; return str.length <= maxLength ? str : str.substr(0, maxLength) + '...'; }
        function getCategoryIcon(categoryId) { const cat = categories.find(c => c.id === categoryId); return cat ? cat.icon : 'bi-folder'; }
        function getCategoryName(categoryId) { const cat = categories.find(c => c.id === categoryId); return cat ? cat.name : 'Outros'; }

        const app = { init, openModal, copyToClipboard };
        window.MCredApp = app;
        return app;
    })();

    // Initialize when page loads or if loaded dynamically
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', MCredApp.init);
    } else {
        // If already loaded (SPA navigation), run immediately
        setTimeout(MCredApp.init, 50); // Small delay to ensure DOM injection
    }
</script>