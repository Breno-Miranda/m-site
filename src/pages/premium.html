<section class="dev-section pt-5 mt-5" style="min-height: 100vh;">
    <div class="container">

        <!-- Dashboard Header -->
        <div class="row align-items-end mb-5">
            <div class="col-lg-8">
                <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 mb-3">
                    <i class="bi bi-speedometer2 me-2"></i>Dashboard Premium
                </span>
                <h2 class="display-5 fw-bold mb-2">Olá, <span id="user-name" class="text-gradient">Visitante</span></h2>
                <p class="text-secondary lead mb-0">Bem-vindo ao seu painel de controle exclusivo.</p>
            </div>
            <div class="col-lg-4 text-lg-end mt-4 mt-lg-0">
                <div class="d-flex gap-2 justify-content-lg-end">
                    <a href="/marketplace" class="btn btn-outline-light">
                        <i class="bi bi-shop me-2"></i>Marketplace
                    </a>
                    <a href="/profile" class="btn btn-dark border-secondary">
                        <i class="bi bi-gear-fill me-2"></i>Configurações
                    </a>
                </div>
            </div>
        </div>

        <!-- Auth Guard & Content -->
        <div id="premium-content" style="display: none;">

            <!-- Quick Stats -->
            <div class="row g-4 mb-5">
                <div class="col-md-3">
                    <div class="card bg-dark border-secondary bg-opacity-50 h-100">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between mb-3">
                                <div class="bg-primary bg-opacity-10 p-3 rounded-3 text-primary">
                                    <i class="bi bi-grid-fill fs-4"></i>
                                </div>
                                <span
                                    class="badge bg-success bg-opacity-10 text-success h-auto align-self-start">Ativo</span>
                            </div>
                            <h3 class="fw-bold mb-1" id="stats-apps">3</h3>
                            <p class="text-muted small mb-0">Apps Instalados</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-dark border-secondary bg-opacity-50 h-100">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between mb-3">
                                <div class="bg-info bg-opacity-10 p-3 rounded-3 text-info">
                                    <i class="bi bi-hdd-network fs-4"></i>
                                </div>
                                <span class="badge bg-info bg-opacity-10 text-info h-auto align-self-start">+12%</span>
                            </div>
                            <h3 class="fw-bold mb-1">1.2k</h3>
                            <p class="text-muted small mb-0">Requisições API/mês</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-dark border-secondary bg-opacity-50 h-100">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between mb-3">
                                <div class="bg-warning bg-opacity-10 p-3 rounded-3 text-warning">
                                    <i class="bi bi-cloud-check fs-4"></i>
                                </div>
                                <span class="text-muted small">50GB Max</span>
                            </div>
                            <h3 class="fw-bold mb-1">45%</h3>
                            <p class="text-muted small mb-0">Armazenamento Usado</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-gradient-primary text-white border-0 h-100">
                        <div class="card-body p-4 position-relative overflow-hidden">
                            <div class="position-absolute top-0 end-0 p-4 opacity-25">
                                <i class="bi bi-stars display-4"></i>
                            </div>
                            <h5 class="fw-bold mb-3">Plano Premium</h5>
                            <p class="small mb-4 opacity-75">Sua assinatura expira em 18 de Fev, 2026.</p>
                            <a href="/#contact" class="btn btn-sm btn-light text-primary fw-bold rounded-pill px-3">
                                Gerenciar Plano
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Apps Section -->
            <div class="d-flex align-items-center justify-content-between mb-4">
                <h4 class="mb-0 fw-bold"><i class="bi bi-box-seam me-2 text-primary"></i>Meus Aplicativos</h4>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                        data-bs-toggle="dropdown">
                        Filtrar por
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark">
                        <li><a class="dropdown-item active" href="#">Todos</a></li>
                        <li><a class="dropdown-item" href="#">Instalados</a></li>
                        <li><a class="dropdown-item" href="#">Não Instalados</a></li>
                    </ul>
                </div>
            </div>

            <div class="row g-4">

                <!-- HealthTech App -->
                <div class="col-lg-4 col-md-6">
                    <div class="card bg-dark border-secondary h-100 hover-card transition-all">
                        <div
                            class="card-header bg-transparent border-0 pt-4 px-4 d-flex justify-content-between align-items-start">
                            <div class="bg-warning bg-opacity-10 p-3 rounded-3 text-warning">
                                <i class="bi bi-activity fs-3"></i>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-link text-secondary p-0" data-bs-toggle="dropdown"><i
                                        class="bi bi-three-dots-vertical"></i></button>
                                <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark">
                                    <li><a class="dropdown-item" href="#"><i
                                                class="bi bi-gear me-2"></i>Configurações</a></li>
                                    <li><a class="dropdown-item text-danger" href="#"><i
                                                class="bi bi-trash me-2"></i>Desinstalar</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="card-body px-4 pb-4">
                            <h4 class="fw-bold mb-2">HealthTech OS</h4>
                            <p class="text-secondary small mb-4">Sistema completo para gestão de clínicas e pacientes
                                com dashboard preditivo.</p>

                            <div class="d-flex align-items-center justify-content-between mt-auto">
                                <small class="text-success"><i class="bi bi-circle-fill me-1"
                                        style="font-size: 6px;"></i> Online</small>
                                <button id="btn-open-healthtech" class="btn btn-warning rounded-pill px-4"
                                    onclick="window.openDashboard()">
                                    <i class="bi bi-play-circle-fill me-2"></i>Abrir
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MCredential App -->
                <div class="col-lg-4 col-md-6">
                    <div class="card bg-dark border-secondary h-100 hover-card transition-all">
                        <div
                            class="card-header bg-transparent border-0 pt-4 px-4 d-flex justify-content-between align-items-start">
                            <div class="bg-success bg-opacity-10 p-3 rounded-3 text-success">
                                <i class="bi bi-shield-lock fs-3"></i>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-link text-secondary p-0" data-bs-toggle="dropdown"><i
                                        class="bi bi-three-dots-vertical"></i></button>
                                <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark">
                                    <li><a class="dropdown-item" href="#"><i
                                                class="bi bi-gear me-2"></i>Configurações</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="card-body px-4 pb-4">
                            <h4 class="fw-bold mb-2">MCredential</h4>
                            <p class="text-secondary small mb-4">Gerenciador de senhas corporativo com criptografia de
                                ponta a ponta.</p>

                            <div class="d-flex align-items-center justify-content-between mt-auto">
                                <small class="text-success"><i class="bi bi-circle-fill me-1"
                                        style="font-size: 6px;"></i> Protegido</small>
                                <button class="btn btn-success rounded-pill px-4"
                                    onclick="window.location.href='/mcredential'">
                                    <i class="bi bi-play-circle-fill me-2"></i>Abrir
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CodeGen App (Coming Soon) -->
                <div class="col-lg-4 col-md-6">
                    <div class="card bg-dark border-secondary h-100 opacity-75">
                        <div
                            class="card-header bg-transparent border-0 pt-4 px-4 d-flex justify-content-between align-items-start">
                            <div class="bg-info bg-opacity-10 p-3 rounded-3 text-info">
                                <i class="bi bi-cpu fs-3"></i>
                            </div>
                            <span class="badge bg-secondary">Em Manutenção</span>
                        </div>
                        <div class="card-body px-4 pb-4">
                            <h4 class="fw-bold mb-2">IA CodeGen</h4>
                            <p class="text-secondary small mb-4">Gerador de código inteligente para React e Node.js.</p>

                            <div class="d-flex align-items-center justify-content-between mt-auto">
                                <small class="text-warning"><i class="bi bi-cone-striped me-1"></i> Offline</small>
                                <button class="btn btn-outline-secondary rounded-pill px-4" disabled>
                                    <i class="bi bi-clock me-2"></i>Aguarde
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add New -->
                <div class="col-lg-4 col-md-6">
                    <a href="/marketplace"
                        class="card bg-dark border-secondary h-100 text-decoration-none border-dashed mb-0 d-flex flex-column align-items-center justify-content-center p-5 hover-bg-secondary transition-all">
                        <div class="bg-secondary bg-opacity-25 p-3 rounded-circle text-white mb-3">
                            <i class="bi bi-plus-lg fs-3"></i>
                        </div>
                        <h5 class="fw-bold text-white">Adicionar Novo App</h5>
                        <p class="text-center text-muted small px-4">Explore o marketplace para turbinar seu workflow.
                        </p>
                    </a>
                </div>

            </div>
        </div>

        <!-- Access Denied State -->
        <div id="access-denied" class="text-center py-5" style="display: none;">
            <div class="mb-4">
                <i class="bi bi-shield-lock text-danger" style="font-size: 5rem;"></i>
            </div>
            <h2 class="display-6 fw-bold mb-3">Acesso Restrito</h2>
            <p class="text-muted lead mb-4 mx-auto" style="max-width: 500px;">
                Esta área é exclusiva para assinantes com plano ativo. Faça login ou atualize sua conta para continuar.
            </p>
            <div class="d-flex justify-content-center gap-3">
                <a href="/login" class="btn btn-primary px-4 py-2 fw-bold">Fazer Login</a>
                <a href="/#contact" class="btn btn-outline-light px-4 py-2">Ver Planos</a>
            </div>
        </div>

    </div>
</section>

<!-- Install Overlay (Preserved Logic) -->
<div id="premium-install-overlay" class="fade-in"
    style="display: none; position: fixed; inset: 0; background: rgba(5, 5, 10, 0.95); backdrop-filter: blur(15px); z-index: 9999; flex-direction: column; align-items: center; justify-content: center;">
    <div class="text-center p-5 rounded-4 border border-secondary border-opacity-25"
        style="background: rgba(20, 20, 30, 0.8); max-width: 400px; width: 90%;">
        <div class="mb-4 position-relative d-inline-block">
            <i class="bi bi-hexagon-fill text-primary text-opacity-25" style="font-size: 6rem;"></i>
            <i class="bi bi-cloud-arrow-down-fill text-primary position-absolute top-50 start-50 translate-middle"
                style="font-size: 3rem;"></i>
        </div>
        <h3 class="text-white mb-2 fw-bold">Instalando Módulo...</h3>
        <p class="text-secondary small mb-4" id="install-status">Inicializando HealthTech OS</p>

        <div class="progress bg-dark border border-secondary border-opacity-25"
            style="height: 6px; border-radius: 10px;">
            <div id="install-progress" class="progress-bar bg-gradient-primary" role="progressbar" style="width: 0%">
            </div>
        </div>
        <div class="d-flex justify-content-between text-muted small mt-2">
            <span>0%</span>
            <span id="install-percent">0%</span>
        </div>
    </div>
</div>

<style>
    .border-dashed {
        border-style: dashed !important;
    }

    .hover-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        border-color: var(--dev-accent-primary);
    }

    .hover-bg-secondary:hover {
        background-color: rgba(255, 255, 255, 0.03) !important;
        border-color: var(--dev-text-muted);
    }

    .text-gradient {
        background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 50%, #10b981 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .cursor-pointer {
        cursor: pointer;
    }

    .dropdown-menu-dark {
        background-color: #1a1a25;
        border-color: #2d2d3f;
    }

    .dropdown-item {
        color: #a0a0b0;
    }

    .dropdown-item:hover {
        background-color: rgba(59, 130, 246, 0.1);
        color: white;
    }
</style>

<script>
    (function () {
        const auth = window.authService;
        const content = document.getElementById('premium-content');
        const denied = document.getElementById('access-denied');
        const APP_KEY = 'healthtech_os_v1';
        const APP_NAME = 'HealthTech Analytics';

        let isAppInstalled = false;

        // Install Effect Logic (Preserved)
        window.openDashboard = async function () {
            if (isAppInstalled) {
                window.location.href = '/healthtech-dashboard';
                return;
            }

            const overlay = document.getElementById('premium-install-overlay');
            const progressBar = document.getElementById('install-progress');
            const statusText = document.getElementById('install-status');
            const percentText = document.getElementById('install-percent');

            overlay.style.display = 'flex';
            let progress = 0;

            const steps = [
                { pct: 10, text: 'Validando credenciais...' },
                { pct: 30, text: 'Carregando dados de pacientes...' },
                { pct: 60, text: 'Sincronizando fórmulas...' },
                { pct: 85, text: 'Gerando analytics...' },
                { pct: 100, text: 'Instalação concluída!' }
            ];

            const interval = setInterval(async () => {
                progress += Math.floor(Math.random() * 8) + 2;
                if (progress > 100) progress = 100;

                progressBar.style.width = `${progress}%`;
                percentText.textContent = `${progress}%`;

                const step = steps.find(s => progress >= s.pct && progress < s.pct + 25);
                if (step) statusText.textContent = step.text;

                if (progress >= 100) {
                    clearInterval(interval);
                    try {
                        const user = auth.getUser();
                        await window.core.fetchAPI('/apps/install', 'POST', {
                            name: APP_NAME,
                            appKey: APP_KEY,
                            userId: user.id || user._id
                        });
                        isAppInstalled = true;
                        updateButtonState();
                        setTimeout(() => {
                            window.location.href = '/healthtech-dashboard';
                        }, 500);
                    } catch (err) {
                        console.error('Install failed', err);
                        window.core.toast('Erro ao registrar instalação.', 'error');
                        overlay.style.display = 'none';
                    }
                }
            }, 50);
        }

        function updateButtonState() {
            const btn = document.getElementById('btn-open-healthtech');
            if (!btn) return;

            if (isAppInstalled) {
                btn.innerHTML = '<i class="bi bi-play-circle-fill me-2"></i>Abrir';
                btn.classList.remove('btn-outline-warning');
                btn.classList.add('btn-warning');
            } else {
                btn.innerHTML = '<i class="bi bi-cloud-arrow-down-fill me-2"></i>Instalar';
                btn.classList.add('btn-warning');
            }
        }

        async function checkInstalledApps() {
            if (!auth.isAuthenticated()) return;
            const user = auth.getUser();
            try {
                const response = await window.core.fetchAPI(`/apps?userId=${user.id || user._id}`);
                if (response && response.success && Array.isArray(response.data)) {
                    if (response.data.find(app => app.appKey === APP_KEY)) {
                        isAppInstalled = true;
                    }
                }
                updateButtonState();
            } catch (e) {
                console.warn('Failed to check apps', e);
            }
        }

        // Init
        if (auth && auth.isAuthenticated()) {
            const user = auth.getUser();
            document.getElementById('user-name').textContent = user.name ? user.name.split(' ')[0] : 'Usuário';

            if (user.role === 'premium' || user.role === 'admin') {
                content.style.display = 'block';
                checkInstalledApps();
            } else {
                denied.style.display = 'block';
            }
        } else {
            denied.style.display = 'block';
        }
    })();
</script>